<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Mock Interview | Placement Tracker</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-slate-900 text-white min-h-screen flex flex-col relative overflow-hidden antialiased">

    <!-- Simple Nav -->
    <nav class="absolute top-0 left-0 w-full p-6 z-50 flex justify-between items-center">
        <a href="{% url 'dashboard' %}"
            class="text-slate-400 hover:text-white transition-colors flex items-center gap-2 font-medium bg-slate-800/50 px-4 py-2 rounded-lg backdrop-blur-sm border border-slate-700">
            <i class="fa-solid fa-arrow-left"></i> Dashboard
        </a>
        <div class="flex items-center gap-2 text-slate-400 font-medium">
            <i class="fa-solid fa-circle text-[10px] text-green-500"></i> AI Engine Active
        </div>
    </nav>

    <!-- Background Accents -->
    <div
        class="absolute top-0 right-0 w-[500px] h-[500px] bg-blue-600 rounded-full blur-[150px] opacity-20 transform translate-x-1/2 -translate-y-1/2 pointer-events-none">
    </div>
    <div
        class="absolute bottom-0 left-0 w-[400px] h-[400px] bg-indigo-600 rounded-full blur-[150px] opacity-20 transform -translate-x-1/2 translate-y-1/2 pointer-events-none">
    </div>

    <div class="flex-grow flex items-center justify-center p-6 mt-16 z-10">
        <div class="w-full max-w-6xl flex flex-col lg:flex-row gap-8">

            <!-- Left: Webcam Area -->
            <div
                class="w-full lg:w-2/3 bg-slate-800/80 backdrop-blur-md border border-slate-700 rounded-2xl p-5 shadow-2xl relative">

                <div
                    class="absolute top-8 left-8 bg-black/60 backdrop-blur-md px-3 py-1.5 rounded-lg text-xs font-semibold tracking-wider flex items-center gap-2 z-20 shadow-lg border border-slate-700">
                    <span id="recordingIndicator"
                        class="w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse hidden"></span>
                    <span id="recordingText">Camera Ready</span>
                </div>

                <div
                    class="relative w-full aspect-video bg-black rounded-xl overflow-hidden shadow-inner border border-slate-900">
                    <video id="webcamPreview" autoplay muted class="w-full h-full object-cover"></video>

                    <div id="countdownOverlay"
                        class="absolute inset-0 bg-slate-900/90 hidden flex-col items-center justify-center z-30 backdrop-blur-sm">
                        <p class="text-xl text-slate-300 mb-4 font-medium tracking-wide">Recording starts in</p>
                        <span id="countdownNumber" class="text-7xl font-black text-blue-500 drop-shadow-lg">3</span>
                    </div>
                </div>

                <!-- Controls -->
                <div class="flex items-center justify-between mt-6 px-2">
                    <div class="flex gap-4">
                        <button id="startBtn"
                            class="px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg shadow-blue-900/50 transition-all flex items-center gap-3 transform hover:scale-105 active:scale-95">
                            <i class="fa-solid fa-video"></i> Start Recording
                        </button>
                        <button id="stopBtn"
                            class="px-8 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-xl shadow-lg shadow-red-900/50 transition-all flex items-center gap-3 hidden transform hover:scale-105 active:scale-95">
                            <i class="fa-solid fa-stop"></i> Finish Interview
                        </button>
                    </div>

                    <div id="recordingTimer"
                        class="font-mono text-2xl text-slate-300 font-bold hidden bg-slate-900 px-4 py-2 rounded-lg border border-slate-700 shadow-inner">
                        00:00
                    </div>
                </div>
            </div>

            <!-- Right: Questions Panel -->
            <div class="w-full lg:w-1/3 flex flex-col h-[500px] lg:h-auto">
                <div
                    class="bg-slate-800/80 backdrop-blur-md border border-slate-700 rounded-2xl p-6 shadow-xl h-full flex flex-col">
                    <div class="flex items-center gap-4 mb-6 pb-5 border-b border-slate-700">
                        <div
                            class="w-12 h-12 rounded-xl bg-blue-900/50 border border-blue-800 text-blue-400 flex items-center justify-center text-2xl shadow-inner">
                            <i class="fa-solid fa-robot"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-xl text-white leading-tight">AI Interviewer</h3>
                            <p class="text-slate-400 text-sm mt-0.5">HR & Behavioral</p>
                        </div>
                    </div>

                    <div class="flex-grow flex flex-col overflow-y-auto pr-2 custom-scrollbar">
                        <p
                            class="text-sm text-blue-400 font-semibold mb-4 uppercase tracking-wider flex items-center gap-2">
                            <i class="fa-solid fa-clipboard-list"></i> Your Questions
                        </p>
                        <p
                            class="text-slate-300 text-sm leading-relaxed mb-6 bg-slate-900/50 p-4 rounded-xl border border-slate-700/50">
                            Please review the questions below. When ready, click <strong>"Start Recording"</strong> and
                            answer them naturally in one continuous take.
                        </p>

                        <div class="space-y-4">
                            {% for question in questions %}
                            <div
                                class="bg-slate-700/40 hover:bg-slate-700/60 transition-colors border border-slate-600/50 p-5 rounded-xl">
                                <h4
                                    class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2 flex justify-between">
                                    <span>Question {{ forloop.counter }}</span>
                                </h4>
                                <p class="text-white text-base font-medium leading-relaxed">{{ question }}</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const webcamPreview = document.getElementById('webcamPreview');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const recordingIndicator = document.getElementById('recordingIndicator');
        const recordingText = document.getElementById('recordingText');
        const recordingTimer = document.getElementById('recordingTimer');
        const countdownOverlay = document.getElementById('countdownOverlay');
        const countdownNumber = document.getElementById('countdownNumber');

        let mediaRecorder;
        let recordedChunks = [];
        let stream;
        let timerInterval;
        let secondsElapsed = 0;

        async function initWebcam() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                webcamPreview.srcObject = stream;
            } catch (err) {
                alert('Error accessing webcam/microphone. Please ensure permissions are granted.');
                console.error(err);
            }
        }

        initWebcam();

        function updateTimerDisplay() {
            const mins = String(Math.floor(secondsElapsed / 60)).padStart(2, '0');
            const secs = String(secondsElapsed % 60).padStart(2, '0');
            recordingTimer.innerText = `${mins}:${secs}`;
        }

        startBtn.addEventListener('click', () => {
            countdownOverlay.classList.remove('hidden');
            countdownOverlay.classList.add('flex');
            let count = 3;
            countdownNumber.innerText = count;

            const countInterval = setInterval(() => {
                count--;
                countdownNumber.innerText = count;
                if (count === 0) {
                    clearInterval(countInterval);
                    countdownOverlay.classList.remove('flex');
                    countdownOverlay.classList.add('hidden');
                    startRecording();
                }
            }, 1000);
        });

        function startRecording() {
            recordedChunks = [];
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp9' });

            mediaRecorder.ondataavailable = event => {
                if (event.data.size > 0) recordedChunks.push(event.data);
            };

            mediaRecorder.onstop = uploadVideo;

            mediaRecorder.start();

            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            recordingIndicator.classList.remove('hidden');
            recordingText.innerText = "Recording";
            recordingText.classList.add('text-red-400');
            recordingTimer.classList.remove('hidden');

            secondsElapsed = 0;
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                secondsElapsed++;
                updateTimerDisplay();
            }, 1000);
        }

        stopBtn.addEventListener('click', () => {
            mediaRecorder.stop();
            stopBtn.disabled = true;
            stopBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Uploading...';
            stopBtn.classList.add('opacity-75', 'cursor-not-allowed');
            clearInterval(timerInterval);
            recordingIndicator.classList.add('hidden');
            recordingText.innerText = "Processing...";
            recordingText.classList.remove('text-red-400');
            recordingText.classList.add('text-blue-400');
        });

        function uploadVideo() {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const formData = new FormData();
            formData.append('video', blob, 'interview.webm');

            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch("{% url 'mock_interview' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.location.href = data.redirect_url;
                    } else {
                        alert('Upload failed. Please try again.');
                        stopBtn.disabled = false;
                        stopBtn.innerHTML = '<i class="fa-solid fa-upload"></i> Retry Upload';
                        stopBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                    }
                })
                .catch(err => {
                    console.error('Upload Error:', err);
                    alert('An error occurred during upload.');
                    stopBtn.disabled = false;
                    stopBtn.innerHTML = '<i class="fa-solid fa-upload"></i> Retry Upload';
                    stopBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                });
        }
    </script>

    <form style="display: none;">{% csrf_token %}</form>

</body>

</html>